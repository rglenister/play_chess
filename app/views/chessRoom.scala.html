@(username: String, jGame: String)(implicit request: RequestHeader)

@main(Some(username)) {
    
    <div class="page-header">
        <h1>Welcome to the chess room <small>You are playing as @username</small></h1>
    </div>
    
    <div id="onError" class="alert-message error">
        <p>
            <strong>Oops!</strong> <span></span>
        </p>
    </div>
    
    <div id="onChess" class="row">
        <div class='span10' id="chessBoard1"></div>  
        <div class="span4">
            <h2>Members</h2>
            <ul id="members">
            </ul>
        </div>
    </div>
      
    <script type="text/javascript" charset="utf-8">
        var console;
        var pieceMoved = function (fromSquare, toSquare) {
                "use strict";
                console.log('pieceMoved -', 'fromSquare', fromSquare, 'toSquare', toSquare);
                sendMessage(fromSquare, toSquare)
            };
        var props = {
                cssPath: '@routes.Assets.at("stylesheets/chess.css")',
                pieceMovedCallback: pieceMoved,
        };
            
        var WS = window['MozWebSocket'] ? MozWebSocket : WebSocket
        var chessSocket = new WS("@routes.Application.chess(username).webSocketURL()")
    
        var sendMessage = function(fromSquare, toSquare) {
            chessSocket.send(JSON.stringify(
                {fromSquare: fromSquare, toSquare: toSquare}
            ))
        }
        var receiveEvent = function(event) {
             var data = JSON.parse(event.data)
             
             // Handle errors
             if(data.error) {
                 chessSocket.close()
                 $("#onError span").text(data.error)
                 $("#onError").show()
                 return
             } else {
                 $("#onChat").show()
             }
             if(data.kind === 'game') {
                 console.log('received message -', data.game);
                 chessObj.loadGame(data.game, boardDiv);                	 
             }
             // Update the members list
             $("#members").html('');
             $(data.members).each(function() {
                 $("#members").append('<li>' + this + '</li>');
             })
        }   
        
        chessObj = new window.DHTMLGoodies.ChessFen(props);
        boardDiv = $('#' + 'chessBoard1')[0];
        chessObj.init(boardDiv);
//        console.log('jGame=' + jGame)
//        var game = JSON.parse(@jGame)
//        console.log('game=' + game)
//        chessObj.loadFen(game.fen, boardDiv)
        
        chessSocket.onmessage = receiveEvent
    </script> 
    
    
}
